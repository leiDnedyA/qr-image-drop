<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>QR Pigeon</title>
    <link rel="stylesheet" href="static/css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="static/assets/favicon.png">
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-title">
                <img src="/static/assets/logo.svg" alt="Logo" class="logo">
                <h1>Upload and Share Files</h1>
            </div>
            <div class="buttons">
                <button onclick="window.location.reload();">üïäÔ∏è Refresh</button>
                <form action="/reset" method="get" class="reset-form">
                    <button type="submit">ü™¶ Reset Session</button>
                </form>
            </div>
        </header>
        <main>
            <section class="qr-code">
                <p>Scan the QR code to upload:</p>
                <img src="data:image/png;base64,{{ qr_code_data }}" alt="QR Code">
                <p class="qr-code-url">QR Code URL: <a target="_blank" href="{{ qr_code_url }}">here.</a></p>
            </section>
            <section class="uploaded-files">
                <h2>Uploaded Files:</h2>
                {% if uploaded_files_urls %}
                <div class="file-grid">
                    {% for file_url in uploaded_files_urls %}
                    <div class="file-container">
                        <img src="{{ file_url }}" class="uploaded-image" alt="Uploaded File">
                        <div class="button-container">
                            <a href="{{ file_url }}" download class="download-button">üõ¨ Download</a>
                            <button onclick="copyImageToClipboard(this)" data-img-src="{{ file_url }}" class="copy-button">üìã Copy</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p>No files uploaded yet.</p>
                {% endif %}
            </section>
        </main>
        <footer>
          <p id="footer-text">Site by <a href="https://edwardgaibor.me/">Edward Gaibor</a> and <a href="https://www.aydendiel.dev/">Ayden Diel</a> | <a href="https://www.buymeacoffee.com/qrpigeon">Buy us a coffee! ‚òï</a></p>
        </footer>
    </div>
    <script>
        async function convertImageToPNG(blob) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function () {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    canvas.toBlob(resolve, 'image/png');
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(blob);
            });
        }

        async function copyImageToClipboard(buttonElement) {
            try {
                const imgSrc = buttonElement.getAttribute('data-img-src');
                const response = await fetch(imgSrc);
                let blob = await response.blob();
                // Convert to PNG if the original image is not in a supported format
                if (blob.type !== 'image/png') {
                    blob = await convertImageToPNG(blob);
                }
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': blob
                    })
                ]);
                alert('Image copied to clipboard!');
            } catch (error) {
                console.error('Error copying image to clipboard', error);
                alert('Failed to copy image to clipboard.');
            }
        }
    </script>

</body>

</html>
